<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocumentAgent - PDF Processing & Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .chat-message {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .upload-area {
            transition: all 0.3s ease;
        }
        .upload-area.dragover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <i class="fas fa-file-pdf text-blue-600 text-2xl mr-3"></i>
                    <h1 class="text-2xl font-bold text-gray-900">DocumentAgent</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="healthCheck" class="text-sm text-gray-500 hover:text-gray-700">
                        <i class="fas fa-heartbeat mr-1"></i>Health Check
                    </button>
                    <div id="statusIndicator" class="w-3 h-3 rounded-full bg-gray-300"></div>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Left Column: PDF Upload and Document List -->
            <div class="space-y-6">
                
                <!-- PDF Upload Section -->
                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-upload mr-2 text-blue-600"></i>Upload PDF Documents
                    </h2>
                    
                                         <div id="uploadArea" class="upload-area border-2 border-dashed border-gray-300 rounded-lg p-8 text-center transition-colors">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-600 mb-2">Drag and drop PDF files here, or</p>
                        <label for="fileInput" class="cursor-pointer">
                            <span class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                                Choose Files
                            </span>
                        </label>
                        <input id="fileInput" type="file" accept=".pdf" multiple class="hidden">
                        <p class="text-sm text-gray-500 mt-2">Maximum file size: 100MB</p>
                    </div>
                    
                    <div id="uploadProgress" class="hidden mt-4">
                        <div class="flex items-center space-x-2">
                            <div class="loading-spinner w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full"></div>
                            <span class="text-sm text-gray-600">Processing PDF...</span>
                        </div>
                    </div>
                    
                    <div id="uploadResult" class="hidden mt-4"></div>
                </div>

                <!-- Document List Section -->
                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold text-gray-900">
                            <i class="fas fa-folder-open mr-2 text-green-600"></i>Processed Documents
                        </h2>
                        <button id="refreshDocs" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-sync-alt mr-1"></i>Refresh
                        </button>
                    </div>
                    
                    <div id="documentList" class="space-y-3">
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-file-pdf text-4xl mb-2"></i>
                            <p>No documents processed yet</p>
                            <p class="text-sm">Upload a PDF to get started</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Chat Interface -->
            <div class="bg-white rounded-lg shadow-sm border p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-comments mr-2 text-purple-600"></i>Chat with Documents
                    </h2>
                    <button id="clearChat" class="text-red-600 hover:text-red-800 text-sm">
                        <i class="fas fa-trash mr-1"></i>Clear Chat
                    </button>
                </div>
                
                <!-- Chat Messages -->
                <div id="chatMessages" class="space-y-4 mb-4 h-96 overflow-y-auto border rounded-lg p-4 bg-gray-50">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-robot text-4xl mb-2"></i>
                        <p>Start a conversation about your documents</p>
                        <p class="text-sm">Ask questions about your PDFs or general topics</p>
                    </div>
                </div>
                
                <!-- Chat Input -->
                <div class="flex space-x-2">
                    <input id="chatInput" type="text" placeholder="Ask about your documents or any general topic..." 
                           class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <button id="sendMessage" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                
                <div id="chatStatus" class="hidden mt-2 text-sm text-gray-500">
                    <div class="flex items-center space-x-2">
                        <div class="loading-spinner w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full"></div>
                        <span>Generating response...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

         <!-- Toast Notifications -->
     <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>
     
     <!-- Delete Confirmation Modal -->
     <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
         <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
             <div class="flex items-center mb-4">
                 <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-3">
                     <i class="fas fa-exclamation-triangle text-red-500"></i>
                 </div>
                 <h3 class="text-lg font-semibold text-gray-900">Delete Document</h3>
             </div>
             <p class="text-gray-600 mb-6" id="deleteModalMessage"></p>
             <div class="flex space-x-3">
                 <button id="confirmDelete" class="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                     Delete
                 </button>
                 <button id="cancelDelete" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">
                     Cancel
                 </button>
             </div>
         </div>
     </div>

    <script>
        // Global variables
        let chatHistory = [];
        
        // DOM elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadProgress = document.getElementById('uploadProgress');
        const uploadResult = document.getElementById('uploadResult');
        const documentList = document.getElementById('documentList');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendMessage = document.getElementById('sendMessage');
        const chatStatus = document.getElementById('chatStatus');
        const refreshDocs = document.getElementById('refreshDocs');
        const clearChat = document.getElementById('clearChat');
        const healthCheck = document.getElementById('healthCheck');
        const statusIndicator = document.getElementById('statusIndicator');

                 // Initialize
         document.addEventListener('DOMContentLoaded', function() {
             setupEventListeners();
             loadDocuments();
             checkHealth();
             
             // Modal event listeners
             document.getElementById('confirmDelete').addEventListener('click', confirmDeleteAction);
             document.getElementById('cancelDelete').addEventListener('click', cancelDelete);
         });

        function setupEventListeners() {
            // File upload
            fileInput.addEventListener('change', handleFileSelect);
            
            // Drag and drop
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
            
            // Chat
            sendMessage.addEventListener('click', sendChatMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendChatMessage();
            });
            
            // Other buttons
            refreshDocs.addEventListener('click', loadDocuments);
            clearChat.addEventListener('click', clearChatHistory);
            healthCheck.addEventListener('click', checkHealth);
        }

        // File upload handlers
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            files.forEach(uploadFile);
        }

        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = Array.from(e.dataTransfer.files).filter(file => file.type === 'application/pdf');
            files.forEach(uploadFile);
        }

        async function uploadFile(file) {
            if (file.type !== 'application/pdf') {
                showToast('Only PDF files are allowed', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            uploadProgress.classList.remove('hidden');
            uploadResult.classList.add('hidden');

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    showToast(result.message, 'success');
                    loadDocuments();
                } else {
                    showToast(result.error, 'error');
                }
            } catch (error) {
                showToast('Upload failed: ' + error.message, 'error');
            } finally {
                uploadProgress.classList.add('hidden');
                uploadResult.classList.remove('hidden');
                fileInput.value = '';
            }
        }

                 // Document management
         let documentToDelete = null;
         
         async function deleteDocument(filename) {
             documentToDelete = filename;
             const chunkCount = getDocumentChunkCount(filename);
             
             document.getElementById('deleteModalMessage').textContent = 
                 `Are you sure you want to delete "${filename}" and all its ${chunkCount} chunks? This action cannot be undone.`;
             
             document.getElementById('deleteModal').classList.remove('hidden');
         }
         
         async function confirmDeleteAction() {
             if (!documentToDelete) return;
             
             try {
                 const response = await fetch('/delete_document', {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json'
                     },
                     body: JSON.stringify({ filename: documentToDelete })
                 });
                 
                 const result = await response.json();
                 
                 if (result.success) {
                     showToast(result.message, 'success');
                     loadDocuments(); // Refresh the document list
                 } else {
                     showToast(result.error, 'error');
                 }
             } catch (error) {
                 showToast('Failed to delete document: ' + error.message, 'error');
             } finally {
                 document.getElementById('deleteModal').classList.add('hidden');
                 documentToDelete = null;
             }
         }
         
         function cancelDelete() {
             document.getElementById('deleteModal').classList.add('hidden');
             documentToDelete = null;
         }
         
         function truncateFilename(filename, maxLength = 30) {
             if (filename.length <= maxLength) {
                 return filename;
             }
             
             // Keep the file extension
             const lastDotIndex = filename.lastIndexOf('.');
             if (lastDotIndex === -1) {
                 // No extension, just truncate
                 return filename.substring(0, maxLength - 3) + '...';
             }
             
             const name = filename.substring(0, lastDotIndex);
             const extension = filename.substring(lastDotIndex);
             
             // Calculate how much of the name we can show
             const availableLength = maxLength - extension.length - 3; // 3 for "..."
             
             if (availableLength <= 0) {
                 // Extension is too long, just show extension
                 return '...' + extension;
             }
             
             return name.substring(0, availableLength) + '...' + extension;
         }
         
         function getDocumentChunkCount(filename) {
             // This is a helper function to get chunk count for confirmation message
             // We'll get it from the current document list
             const docElement = document.querySelector(`[onclick="deleteDocument('${filename}')"]`);
             if (docElement) {
                 // Find the chunk count element which is now at the bottom right
                 const chunkElement = docElement.parentElement.querySelector('.absolute.bottom-2.right-2 span');
                 if (chunkElement) {
                     return chunkElement.textContent.trim();
                 }
             }
             return 'all';
         }
         
         async function loadDocuments() {
            try {
                const response = await fetch('/documents');
                const result = await response.json();
                
                if (result.success && result.documents.length > 0) {
                    displayDocuments(result.documents);
                } else {
                    displayNoDocuments();
                }
            } catch (error) {
                console.error('Error loading documents:', error);
            }
        }

                 function displayDocuments(documents) {
             const html = documents.map(doc => `
                 <div class="relative p-4 bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition-shadow">
                     <!-- Delete button in upper right corner -->
                     <button onclick="deleteDocument('${doc.filename}')" 
                             class="absolute top-2 right-2 text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition-colors group"
                             title="Delete document">
                         <i class="fas fa-trash text-sm group-hover:scale-110 transition-transform"></i>
                     </button>
                     
                     <!-- Document content -->
                     <div class="flex items-center space-x-3 pr-8">
                         <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center flex-shrink-0">
                             <i class="fas fa-file-pdf text-red-500 text-lg"></i>
                         </div>
                         <div class="flex-1 min-w-0">
                             <p class="font-semibold text-gray-900 text-sm truncate" title="${doc.filename}">${truncateFilename(doc.filename)}</p>
                             <p class="text-xs text-gray-500">${formatDate(doc.uploaded_at)}</p>
                         </div>
                     </div>
                     
                     <!-- Chunk count at bottom right -->
                     <div class="absolute bottom-2 right-2">
                         <span class="text-xs bg-blue-100 text-blue-800 px-3 py-1 rounded-full font-bold">
                             ${doc.chunks}
                         </span>
                     </div>
                 </div>
             `).join('');
            
            documentList.innerHTML = html;
        }

                 function displayNoDocuments() {
             documentList.innerHTML = `
                 <div class="text-center text-gray-400 py-12">
                     <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                         <i class="fas fa-file-pdf text-2xl"></i>
                     </div>
                     <p class="text-gray-600 font-medium mb-1">No documents processed yet</p>
                     <p class="text-sm text-gray-500">Upload a PDF to get started</p>
                 </div>
             `;
         }

        // Chat functionality
        async function sendChatMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            // Add user message to chat
            addChatMessage('user', message);
            chatInput.value = '';
            
            // Disable input while processing
            chatInput.disabled = true;
            sendMessage.disabled = true;
            chatStatus.classList.remove('hidden');

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message })
                });

                const result = await response.json();
                
                if (result.success) {
                    addChatMessage('assistant', result.response);
                    chatHistory = result.chat_history;
                } else {
                    addChatMessage('assistant', 'Error: ' + result.error);
                }
            } catch (error) {
                addChatMessage('assistant', 'Error: ' + error.message);
            } finally {
                chatInput.disabled = false;
                sendMessage.disabled = false;
                chatStatus.classList.add('hidden');
                chatInput.focus();
            }
        }

        function addChatMessage(sender, message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const bubble = document.createElement('div');
            bubble.className = `max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${
                sender === 'user' 
                    ? 'bg-blue-600 text-white' 
                    : 'bg-white border border-gray-200 text-gray-900'
            }`;
            
            bubble.innerHTML = `
                <div class="flex items-start space-x-2">
                    ${sender === 'assistant' ? '<i class="fas fa-robot text-purple-500 mt-1"></i>' : ''}
                    <div class="flex-1">
                        <p class="text-sm">${escapeHtml(message)}</p>
                    </div>
                </div>
            `;
            
            messageDiv.appendChild(bubble);
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Remove placeholder if it exists
            const placeholder = chatMessages.querySelector('.text-center');
            if (placeholder) {
                placeholder.remove();
            }
        }

        function clearChatHistory() {
            chatMessages.innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <i class="fas fa-robot text-4xl mb-2"></i>
                                            <p>Start a conversation about your documents</p>
                        <p class="text-sm">Ask questions about your PDFs or general topics</p>
                </div>
            `;
            chatHistory = [];
            
            fetch('/clear_chat', { method: 'POST' });
        }

        // Health check
        async function checkHealth() {
            try {
                const response = await fetch('/health');
                const result = await response.json();
                
                if (result.status === 'healthy') {
                    statusIndicator.className = 'w-3 h-3 rounded-full bg-green-500';
                    showToast('System healthy - Ollama connected', 'success');
                } else {
                    statusIndicator.className = 'w-3 h-3 rounded-full bg-red-500';
                    showToast('System unhealthy - Ollama disconnected', 'error');
                }
            } catch (error) {
                statusIndicator.className = 'w-3 h-3 rounded-full bg-red-500';
                showToast('Health check failed', 'error');
            }
        }

        // Utility functions
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `p-4 rounded-lg shadow-lg text-white max-w-sm ${
                type === 'success' ? 'bg-green-500' :
                type === 'error' ? 'bg-red-500' :
                'bg-blue-500'
            }`;
            
            toast.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            const container = document.getElementById('toastContainer');
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

                 function formatDate(dateString) {
             if (!dateString || dateString === 'Unknown') return 'Unknown';
             try {
                 const date = new Date(dateString);
                 if (isNaN(date.getTime())) return 'Unknown';
                 
                 const now = new Date();
                 const diffTime = Math.abs(now - date);
                 const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                 
                 if (diffDays === 1) return 'Today';
                 if (diffDays === 2) return 'Yesterday';
                 if (diffDays <= 7) return `${diffDays - 1} days ago`;
                 
                 return date.toLocaleDateString('en-US', { 
                     month: 'short', 
                     day: 'numeric',
                     year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
                 });
             } catch (e) {
                 return 'Unknown';
             }
         }
         
         function escapeHtml(text) {
             const div = document.createElement('div');
             div.textContent = text;
             return div.innerHTML;
         }
    </script>
</body>
</html>
